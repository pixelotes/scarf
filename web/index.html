<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Indexer</title>
    <style>
        :root {
            --bg-color: #1e1e1e; --text-color: #d4d4d4; --primary-color: #007acc;
            --border-color: #333; --header-bg: #252526; --table-header-bg: #333;
            --table-row-hover: #2a2d2e; --success-color: #4ec9b0; --error-color: #f44747;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; }
        main { max-width: 1200px; margin: auto; padding: 2rem; }
        a { color: var(--primary-color); text-decoration: none; }
        a:hover { text-decoration: underline; }
        input, select, button { padding: 0.75rem; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--header-bg); color: var(--text-color); font-size: 1rem; }
        button { background-color: var(--primary-color); border-color: var(--primary-color); cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        
        #login-screen { display: flex; align-items: center; justify-content: center; height: 100vh; }
        #login-form { display: flex; flex-direction: column; gap: 1rem; padding: 2rem; background: var(--header-bg); border-radius: 8px; }

        #app-container { display: none; }
        nav { display: flex; gap: 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 2rem; }
        nav button { background: none; border: none; padding: 1rem; font-size: 1rem; cursor: pointer; color: var(--text-color); border-bottom: 2px solid transparent; }
        nav button.active { border-bottom-color: var(--primary-color); }
        .page { display: none; }
        .page.active { display: block; }
        
        #search-form { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; }
        #search-form input, #search-form select { flex-grow: 1; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { background-color: var(--table-header-bg); }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: #444; }
        th .sort-arrow { display: inline-block; margin-left: 8px; opacity: 0.5; width: 1em; }
        th.active .sort-arrow { opacity: 1; }

        tbody tr:hover { background-color: var(--table-row-hover); }
        .seeders { color: var(--success-color); }
        .leechers { color: var(--error-color); }
        .download-cell { text-align: center; }
        .download-cell a { display: inline-block; padding: 4px; }
        .download-cell svg { width: 20px; height: 20px; stroke: var(--primary-color); fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .download-cell a:hover svg { stroke: var(--text-color); }
        
        #pagination-controls { display: none; justify-content: center; align-items: center; gap: 1rem; margin-top: 2rem; }

        #log-controls { margin-bottom: 1rem; display: flex; gap: 1rem; }
        #log-container { height: 60vh; overflow-y: scroll; background: #111; padding: 1rem; font-family: "Courier New", Courier, monospace; font-size: 0.9rem; white-space: pre-wrap; }
        
        .status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .status-card { background: var(--header-bg); padding: 1rem; border-radius: 4px; position: relative; }
        .status-card-actions { margin-top: 1rem; display: flex; gap: 0.5rem; }
        .status-card-actions button { font-size: 0.8rem; padding: 0.5rem; }
        .flexget-url { margin-top: 1rem; }
        .tracker-type-tag {
            background-color: var(--primary-color);
            padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; text-transform: capitalize;
        }
        .switch {
            position: absolute; top: 0.5rem; right: 0.5rem; display: inline-block;
            width: 34px; height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s;
        }
        .slider:before {
            position: absolute; content: ""; height: 12px; width: 12px;
            left: 4px; bottom: 4px; background-color: white; transition: .4s;
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--primary-color); }
        input:checked + .slider:before { transform: translateX(14px); }
        .slider.round { border-radius: 20px; }
        .slider.round:before { border-radius: 50%; }

        /* Modal Styles */
        .modal-backdrop {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--header-bg); margin: auto; padding: 2rem;
            border: 1px solid var(--border-color); width: 80%; max-width: 500px;
            border-radius: 8px; position: relative;
        }
        .modal-close {
            color: #aaa; position: absolute; top: 1rem; right: 1.5rem;
            font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .modal-close:hover, .modal-close:focus { color: var(--text-color); }
        .modal-content form { display: flex; flex-direction: column; gap: 1rem; }
        .modal-content form .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .modal-content form .form-group-checkbox { flex-direction: row; align-items: center; }
    </style>
</head>
<body>
    <div id="login-screen">
        <form id="login-form">
            <h2>üß£ Scarf Login</h2>
            <input type="password" id="password-input" placeholder="Password" required>
            <button type="submit">Login</button>
            <p id="login-error" style="color:var(--error-color); text-align:center;"></p>
        </form>
    </div>

    <main id="app-container">
        <nav id="nav-buttons">
            <button data-page="search-page" class="active">Search</button>
            <button data-page="logs-page">Logs</button>
            <button data-page="status-page">Status</button>
        </nav>

        <div id="search-page" class="page active">
            <form id="search-form">
                <select id="indexer-select" name="indexer" required></select>
                <input type="search" id="query-input" name="q" placeholder="Search for...">
                <select id="category-select" name="cat"></select>
                <button type="submit">Search</button>
            </form>
            <p id="search-status" class="status-message">Search to see results.</p>
            <table id="results-table" style="display:none;">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="Title">Title <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort="Size">Size <span class="sort-arrow"></span></th>
                        <th class="sortable seeders" data-sort="Seeders">Seeders <span class="sort-arrow"></span></th>
                        <th class="sortable leechers" data-sort="Leechers">Leechers <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort="PublishDate">Published <span class="sort-arrow"></span></th>
                        <th>DL</th>
                    </tr>
                </thead>
                <tbody id="results-body"></tbody>
            </table>
            <div id="pagination-controls">
                <button id="prev-page-btn">Previous</button>
                <span id="page-info"></span>
                <button id="next-page-btn">Next</button>
            </div>
        </div>

        <div id="logs-page" class="page">
            <div id="log-controls">
                <input type="text" id="log-filter" placeholder="Filter logs...">
            </div>
            <div id="log-container"></div>
        </div>

        <div id="status-page" class="page">
            <h2>Indexer Status</h2>
            <div style="margin-bottom: 1rem; display: flex; gap: 1rem;">
                <button id="test-all-btn">Test All Indexers</button>
                <select id="type-filter">
                    <option value="all">All Types</option>
                    <option value="public">Public</option>
                    <option value="private">Private</option>
                    <option value="semiprivate">Semi-Private</option>
                </select>
            </div>
            <div id="status-grid" class="status-grid"></div>
            <div class="flexget-url">
                <h3>Flexget URL (for 'all' indexers)</h3>
                <p>Use this URL in your Flexget `torznab` configuration:</p>
                <input type="text" id="flexget-url-input" readonly>
            </div>
        </div>
    </main>

    <div id="settings-modal" class="modal-backdrop">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2 id="settings-modal-title">Indexer Settings</h2>
            <p id="settings-modal-desc"></p>
            <form id="settings-modal-form">
                <button type="submit">Save Configuration</button>
            </form>
             <p id="settings-modal-status" style="text-align:center; margin-top:1rem;"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginScreen = document.getElementById('login-screen');
            const loginForm = document.getElementById('login-form');
            const passwordInput = document.getElementById('password-input');
            const loginError = document.getElementById('login-error');
            const appContainer = document.getElementById('app-container');
            let sessionToken = '';
            let allIndexersData = {}; // Cache for indexer data

            // --- State Management for Search Results ---
            let allResults = [];
            let currentPage = 1;
            const resultsPerPage = 50;
            let currentSort = { key: 'Seeders', direction: 'desc' };

            // --- AUTHENTICATION ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginError.textContent = '';
                try {
                    const response = await fetch('/api/v1/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: passwordInput.value })
                    });
                    if (!response.ok) throw new Error('Incorrect password');
                    const { token } = await response.json();
                    sessionToken = token;
                    loginScreen.style.display = 'none';
                    appContainer.style.display = 'block';
                    initializeApp();
                } catch (error) {
                    loginError.textContent = error.message;
                }
            });
            
            // --- APP INITIALIZATION ---
            function initializeApp() {
                document.getElementById('nav-buttons').addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        const pageId = e.target.dataset.page;
                        document.querySelector('#nav-buttons .active').classList.remove('active');
                        e.target.classList.add('active');
                        document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === pageId));
                    }
                });
                document.getElementById('search-form').addEventListener('submit', handleSearchSubmit);
                document.querySelector('#results-table thead').addEventListener('click', handleSortClick);
                document.getElementById('prev-page-btn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderCurrentPage(); } });
                document.getElementById('next-page-btn').addEventListener('click', () => { const totalPages = Math.ceil(allResults.length / resultsPerPage); if (currentPage < totalPages) { currentPage++; renderCurrentPage(); } });
                
                setupSettingsModal();
                loadInitialData();
                setupLogViewer();
                document.getElementById('type-filter').addEventListener('change', renderStatusGrid);
            }
            
            // --- DATA LOADING & CACHING ---
            async function loadInitialData() {
                await fetchIndexerData();
                populateIndexerDropdown();
                renderStatusGrid();
                setupFlexgetURL();
            }

            async function fetchIndexerData() {
                const response = await fetchWithAuth('/api/v1/indexers');
                allIndexersData = await response.json();
            }

            // --- EVENT HANDLERS & API CALLERS ---
            async function handleSearchSubmit(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const indexer = formData.get('indexer');
                const query = formData.get('q');
                const cat = formData.get('cat');
                const searchStatus = document.getElementById('search-status');
                
                searchStatus.textContent = 'Searching...';
                searchStatus.style.display = 'block';
                document.getElementById('results-table').style.display = 'none';
                document.getElementById('pagination-controls').style.display = 'none';
                
                try {
                    const response = await fetchWithAuth(`/api/v1/search?indexer=${indexer}&q=${encodeURIComponent(query)}&cat=${cat}`);
                    if (!response.ok) throw new Error((await response.json()).error || 'Search request failed');
                    allResults = await response.json() || [];
                    currentSort = indexer === 'all' ? { key: 'Seeders', direction: 'desc' } : { key: 'PublishDate', direction: 'desc' };
                    currentPage = 1;
                    renderCurrentPage();
                } catch (error) {
                    searchStatus.textContent = `Error: ${error.message}`;
                }
            }

            function handleSortClick(e) {
                const header = e.target.closest('.sortable');
                if (!header) return;
                const sortKey = header.dataset.sort;
                if (currentSort.key === sortKey) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = sortKey;
                    currentSort.direction = ['Size', 'Seeders', 'Leechers', 'PublishDate'].includes(sortKey) ? 'desc' : 'asc';
                }
                currentPage = 1;
                renderCurrentPage();
            }
            
            // --- UI RENDERING ---
            function populateIndexerDropdown() {
                const indexerSelect = document.getElementById('indexer-select');
                indexerSelect.innerHTML = '<option value="all">All Indexers</option>';
                Object.entries(allIndexersData).sort(([,a],[,b]) => a.name.localeCompare(b.name)).forEach(([key, indexer]) => {
                    if (indexer.enabled) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = indexer.name;
                        indexerSelect.appendChild(option);
                    }
                });
                updateCategoryDropdown();
                indexerSelect.addEventListener('change', updateCategoryDropdown);
            }

            function updateCategoryDropdown() {
                const categorySelect = document.getElementById('category-select');
                const selectedIndexerKey = document.getElementById('indexer-select').value;
                categorySelect.innerHTML = '<option value="">All Categories</option>';

                let categories = {};
                if (selectedIndexerKey === 'all') {
                    Object.values(allIndexersData).forEach(idx => {
                        if (idx.enabled) Object.assign(categories, idx.categories);
                    });
                } else if (allIndexersData[selectedIndexerKey]) {
                    categories = allIndexersData[selectedIndexerKey].categories;
                }
                
                Object.entries(categories).sort(([,a],[,b]) => a.localeCompare(b)).forEach(([id, name]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    categorySelect.appendChild(option);
                });
            }
            
            function renderStatusGrid() {
                const statusGrid = document.getElementById('status-grid');
                const filter = document.getElementById('type-filter').value;
                statusGrid.innerHTML = '';
                
                Object.entries(allIndexersData).forEach(([key, indexer]) => {
                    if (filter !== 'all' && indexer.type !== filter) return;

                    const card = document.createElement('div');
                    card.className = 'status-card';
                    card.innerHTML = `
                        <label class="switch">
                            <input type="checkbox" class="enable-switch" data-key="${key}" ${indexer.enabled ? 'checked' : ''}>
                            <span class="slider round"></span>
                        </label>
                        <h3>${indexer.name}</h3>
                        <p><span class="tracker-type-tag">${indexer.type}</span></p>
                        <p>Status: <span id="status-text-${key}">Unknown</span></p>
                        <div class="status-card-actions">
                            <button class="test-btn" data-key="${key}">Test</button>
                            <button class="copy-btn" data-key="${key}">üìù Copy Link</button>
                            ${(indexer.settings && indexer.settings.length > 0) ? `<button class="settings-btn" data-key="${key}" title="Settings">‚öôÔ∏è</button>` : ''}
                        </div>
                    `;
                    statusGrid.appendChild(card);
                });

                statusGrid.onclick = handleStatusGridClick;
                statusGrid.onchange = handleStatusGridChange;
                document.getElementById('test-all-btn').onclick = () => document.querySelectorAll('.test-btn').forEach(btn => btn.click());
            }
            
            // --- Settings Modal Logic ---
            function setupSettingsModal() {
                const modal = document.getElementById('settings-modal');
                document.querySelector('.modal-close').onclick = () => modal.style.display = "none";
                window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; };
                
                document.getElementById('settings-modal-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const key = formData.get('key');
                    const config = {};
                    formData.forEach((value, name) => {
                        if (name !== 'key') config[name] = value;
                    });
                    
                    // Handle unchecked checkboxes
                    const indexer = allIndexersData[key];
                    indexer.settings?.forEach(setting => {
                        if (setting.type === 'checkbox' && !config.hasOwnProperty(setting.name)) {
                            config[setting.name] = "false";
                        }
                    });

                    const statusEl = document.getElementById('settings-modal-status');
                    statusEl.textContent = 'Saving...';
                    
                    try {
                        const response = await fetchWithAuth('/api/v1/indexer/config', {
                            method: 'POST', body: JSON.stringify({ key, config })
                        });
                        if (!response.ok) throw new Error('Failed to save configuration.');
                        
                        statusEl.textContent = '‚úÖ Saved successfully!';
                        await fetchIndexerData(); // Refresh data from backend
                        setTimeout(() => modal.style.display = "none", 1500);
                    } catch (error) {
                         statusEl.textContent = `Error: ${error.message}`;
                    }
                });
            }
            
            function openSettingsModal(key) {
                const indexer = allIndexersData[key];
                if (!indexer) return;

                const modal = document.getElementById('settings-modal');
                const form = document.getElementById('settings-modal-form');
                
                document.getElementById('settings-modal-title').textContent = `${indexer.name} Settings`;
                document.getElementById('settings-modal-desc').textContent = indexer.description;
                document.getElementById('settings-modal-status').textContent = '';
                
                // Clear old form and add hidden key input
                form.innerHTML = `<input type="hidden" name="key" value="${key}">`;
                
                // Dynamically build form
                indexer.settings?.forEach(setting => {
                    const group = document.createElement('div');
                    group.className = 'form-group';

                    const label = document.createElement('label');
                    label.htmlFor = `setting-${setting.name}`;
                    label.textContent = setting.label;
                    
                    let input;
                    const currentValue = indexer.user_config[setting.name] || setting.default;

                    switch(setting.type) {
                        case 'select':
                            input = document.createElement('select');
                            input.id = `setting-${setting.name}`;
                            input.name = setting.name;
                            Object.entries(setting.options).forEach(([value, text]) => {
                                const option = document.createElement('option');
                                option.value = value;
                                option.textContent = text;
                                if (value === currentValue) option.selected = true;
                                input.appendChild(option);
                            });
                            group.appendChild(label);
                            group.appendChild(input);
                            break;
                        case 'checkbox':
                            input = document.createElement('input');
                            input.type = 'checkbox';
                            input.id = `setting-${setting.name}`;
                            input.name = setting.name;
                            input.value = "true";
                            if (currentValue === "true") input.checked = true;
                            group.classList.add('form-group-checkbox');
                            group.appendChild(input);
                            group.appendChild(label);
                            break;
                        default: // text, password
                            input = document.createElement('input');
                            input.type = setting.type;
                            input.id = `setting-${setting.name}`;
                            input.name = setting.name;
                            input.value = currentValue;
                            group.appendChild(label);
                            group.appendChild(input);
                            break;
                    }
                    form.appendChild(group);
                });

                const submitButton = document.createElement('button');
                submitButton.type = 'submit';
                submitButton.textContent = 'Save Configuration';
                form.appendChild(submitButton);

                modal.style.display = 'flex';
            }

            // --- Click/Change Handlers for Status Grid ---
            async function handleStatusGridClick(e) {
                const key = e.target.dataset.key;
                if (!key) return;

                if (e.target.matches('.test-btn')) {
                    const statusText = document.getElementById(`status-text-${key}`);
                    statusText.textContent = 'Testing...';
                    const response = await fetchWithAuth(`/api/v1/test_indexer?indexer=${key}`);
                    const data = await response.json();
                    statusText.textContent = data.ok ? 'üü¢ OK' : `üî¥ Failed: ${data.error}`;
                } else if (e.target.matches('.copy-btn')) {
                    const apiKey = (await (await fetchWithAuth('/api/v1/flexget_key')).json()).key;
                    navigator.clipboard.writeText(`${window.location.origin}/torznab/${key}?apikey=${apiKey}`);
                    e.target.textContent = 'Copied!';
                    setTimeout(() => e.target.textContent = 'üìù Copy Link', 1500);
                } else if (e.target.matches('.settings-btn')) {
                    openSettingsModal(key);
                }
            }
            async function handleStatusGridChange(e) {
                 if (e.target.matches('.enable-switch')) {
                    const key = e.target.dataset.key;
                    const enabled = e.target.checked;
                    try {
                        const response = await fetchWithAuth('/api/v1/indexer/toggle', {
                            method: 'POST', body: JSON.stringify({ key, enabled })
                        });
                        if (!response.ok) throw new Error('Failed to toggle indexer');
                        allIndexersData[key].enabled = enabled; // Update local state
                        populateIndexerDropdown(); // Refresh dropdown
                    } catch (error) {
                        console.error(error);
                        e.target.checked = !enabled; // Revert on error
                    }
                }
            }
            
            // --- Helper Functions ---
            function renderCurrentPage() {
                const searchStatus = document.getElementById('search-status');
                const resultsTable = document.getElementById('results-table');
                const resultsBody = document.getElementById('results-body');
                const paginationControls = document.getElementById('pagination-controls');
                
                if (!allResults || allResults.length === 0) {
                    searchStatus.textContent = 'No results found.';
                    searchStatus.style.display = 'block';
                    resultsTable.style.display = 'none';
                    paginationControls.style.display = 'none';
                    return;
                }
                
                sortResults();
                
                searchStatus.style.display = 'none';
                resultsTable.style.display = 'table';
                resultsBody.innerHTML = '';

                const totalPages = Math.ceil(allResults.length / resultsPerPage);
                const pageResults = allResults.slice((currentPage - 1) * resultsPerPage, currentPage * resultsPerPage);

                pageResults.forEach(item => {
                    const row = resultsBody.insertRow();
                    row.innerHTML = `
                        <td>${item.Title}</td>
                        <td>${formatBytes(item.Size)}</td>
                        <td class="seeders">${item.Seeders}</td>
                        <td class="leechers">${item.Leechers}</td>
                        <td>${item.PublishDate ? new Date(item.PublishDate).toLocaleString() : 'N/A'}</td>
                        <td class="download-cell">
                            <a href="${item.DownloadURL}" title="Get magnet link or torrent file">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            </a>
                        </td>`;
                });

                document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prev-page-btn').disabled = currentPage === 1;
                document.getElementById('next-page-btn').disabled = currentPage === totalPages;
                paginationControls.style.display = 'flex';
                
                document.querySelectorAll('#results-table thead th.sortable').forEach(th => {
                    const sortKey = th.dataset.sort;
                    const arrow = th.querySelector('.sort-arrow');
                    th.classList.toggle('active', sortKey === currentSort.key);
                    if (sortKey === currentSort.key) arrow.innerHTML = currentSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
                    else arrow.innerHTML = '';
                });
            }

            function sortResults() {
                const { key, direction } = currentSort;
                const dir = direction === 'asc' ? 1 : -1;
                allResults.sort((a, b) => {
                    const valA = a[key];
                    const valB = b[key];
                    if (typeof valA === 'string') return valA.localeCompare(valB) * dir;
                    return (valA - valB) * dir;
                });
            }

            async function setupFlexgetURL() {
                const flexgetRes = await fetchWithAuth('/api/v1/flexget_key');
                const flexgetData = await flexgetRes.json();
                document.getElementById('flexget-url-input').value = `${window.location.origin}/torznab/all?apikey=${flexgetData.key}`;
            }

            function setupLogViewer() {
                const logContainer = document.getElementById('log-container');
                const logFilter = document.getElementById('log-filter');
                const ws = new WebSocket(`ws://${window.location.host}/api/v1/logs?token=${sessionToken}`);
                ws.onmessage = (event) => {
                    const logLine = document.createElement('div');
                    logLine.className = 'log-line';
                    logLine.textContent = event.data;
                    logContainer.appendChild(logLine);
                    if (logContainer.scrollHeight - logContainer.scrollTop < logContainer.clientHeight + 200) {
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                    applyLogFilter();
                };
                logFilter.addEventListener('input', applyLogFilter);
                function applyLogFilter() {
                    const filterText = logFilter.value.toLowerCase();
                    logContainer.querySelectorAll('.log-line').forEach(line => {
                        line.style.display = line.textContent.toLowerCase().includes(filterText) ? '' : 'none';
                    });
                }
            }

            async function fetchWithAuth(url, options = {}) {
                const headers = { ...options.headers };
                headers['Authorization'] = `Bearer ${sessionToken}`;
                if (options.body) headers['Content-Type'] = 'application/json';
                const response = await fetch(url, { ...options, headers });
                if (response.status === 401) window.location.reload();
                return response;
            }

            function formatBytes(bytes, decimals = 2) {
                if (!bytes) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html>